name: Initialize PharmacyHub VPS Infrastructure

# Force the use of bash shell for all run steps
defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to initialize'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod
      force_recreate:
        description: 'Force recreate networks and directories'
        required: false
        type: boolean
        default: false

env:
  VPS_HOST: '103.135.45.76'
  VPS_USER: 'root'
  VPS_PORT: '22'
  CI: 'true'

jobs:
  initialize-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Disable host key checking
          echo "Host ${{ env.VPS_HOST }}" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} 'echo "SSH connection successful"'

      - name: Copy infrastructure scripts
        run: |
          # Create a working directory
          mkdir -p ./infrastructure_setup
          
          # Copy setup script with modifications
          cp deploy/scripts/setup-vps-directories.sh ./infrastructure_setup/
          
          # Create network setup script
          cat > ./infrastructure_setup/setup-networks.sh << 'EOF'
          #!/bin/bash
          # setup-networks.sh
          # Creates the necessary Docker networks for PharmacyHub environments
          
          # Exit on any error
          set -e
          
          # Environment names
          ENVIRONMENTS=("dev" "qa" "prod")
          
          echo "Setting up Docker networks for PharmacyHub..."
          
          # Create the shared proxy network if it doesn't exist
          if ! docker network inspect proxy-network >/dev/null 2>&1; then
            echo "Creating proxy-network..."
            docker network create proxy-network
          else
            echo "proxy-network already exists."
          fi
          
          # Create environment-specific networks
          for ENV in "${ENVIRONMENTS[@]}"; do
            NETWORK_NAME="pharmacyhub-${ENV}-network"
            
            if ! docker network inspect $NETWORK_NAME >/dev/null 2>&1; then
              echo "Creating $NETWORK_NAME..."
              docker network create $NETWORK_NAME
            else
              echo "$NETWORK_NAME already exists."
            fi
          done
          
          echo "Docker network setup completed successfully!"
          EOF
          
          # Make scripts executable
          chmod +x ./infrastructure_setup/*.sh
          
          # Copy scripts to server
          scp -i ~/.ssh/id_rsa -P ${{ env.VPS_PORT }} -r ./infrastructure_setup/* ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/

      - name: Setup VPS directories
        run: |
          echo "Setting up directory structure on VPS..."
          ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cd /opt && chmod +x setup-vps-directories.sh && ./setup-vps-directories.sh"
          
          echo "VPS directory structure created successfully!"

      - name: Setup Docker networks
        run: |
          echo "Setting up Docker networks on VPS..."
          ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cd /opt && chmod +x setup-networks.sh && ./setup-networks.sh"
          
          echo "Docker networks created successfully!"

      - name: Deploy Nginx and Portainer
        run: |
          echo "Deploying Nginx Proxy Manager and Portainer..."
          # Copy infrastructure files
          mkdir -p ./proxy_setup
          cp -r deploy/infrastructure/proxy/* ./proxy_setup/
          
          # Create base directory on VPS
          ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "mkdir -p /opt/PharmacyHub/infrastructure/proxy"
          
          # Copy files to VPS
          scp -i ~/.ssh/id_rsa -P ${{ env.VPS_PORT }} -r ./proxy_setup/* ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/PharmacyHub/infrastructure/proxy/
          
          # Create the setup-proxy-configs.sh script
          cat > setup-proxy-configs.sh << 'EOF'
          #!/bin/bash
          # Script to generate and set up Nginx Proxy Manager configurations
          
          # Ensure proxy configuration directories exist
          mkdir -p /opt/PharmacyHub/infrastructure/proxy/data/nginx/proxy_host
          mkdir -p /opt/PharmacyHub/infrastructure/proxy/data/letsencrypt-acme-challenge
          mkdir -p /opt/PharmacyHub/infrastructure/proxy/data/nginx/custom
          
          # Create empty custom server_proxy.conf if it doesn't exist
          if [ ! -f "/opt/PharmacyHub/infrastructure/proxy/data/nginx/custom/server_proxy.conf" ]; then
            touch "/opt/PharmacyHub/infrastructure/proxy/data/nginx/custom/server_proxy.conf"
          fi
          
          # Define environments and their corresponding configs
          ENVS=("dev" "qa" "prod")
          
          # Frontend configurations
          for ENV in "${ENVS[@]}"; do
            # Set variables based on environment
            if [ "$ENV" == "prod" ]; then
              DOMAIN="www.pharmacyhub.pk"
              PORT="3000"
              CONTAINER="pharmacyhub-frontend-prod"
              CONFIG_ID="9"
            elif [ "$ENV" == "qa" ]; then
              DOMAIN="qa.pharmacyhub.pk"
              PORT="3000"
              CONTAINER="pharmacyhub-frontend-qa"
              CONFIG_ID="5"
            else
              DOMAIN="dev.pharmacyhub.pk"
              PORT="3000"
              CONTAINER="pharmacyhub-frontend-dev"
              CONFIG_ID="1"
            fi
            
            # Create frontend proxy config
            cat > "/opt/PharmacyHub/infrastructure/proxy/data/nginx/proxy_host/${CONFIG_ID}.conf" << EOFINNER
          # ------------------------------------------------------------
          # ${DOMAIN}
          # ------------------------------------------------------------
          
          map \$scheme \$hsts_header {
              https   "max-age=63072000; preload";
          }
          
          server {
            set \$forward_scheme http;
            set \$server         "${CONTAINER}";
            set \$port           ${PORT};
          
            listen 80;
            listen [::]:80;
          
            server_name ${DOMAIN};
          
            access_log /data/logs/proxy-host-${CONFIG_ID}_access.log proxy;
            error_log /data/logs/proxy-host-${CONFIG_ID}_error.log warn;
          
            location / {
              # Proxy!
              include conf.d/include/proxy.conf;
            }
          
            # Custom
            include /data/nginx/custom/server_proxy[.]conf;
          }
          EOFINNER
          
            echo "Created frontend proxy config for ${DOMAIN}"
          done
          
          # Backend configurations
          for ENV in "${ENVS[@]}"; do
            # Set variables based on environment
            if [ "$ENV" == "prod" ]; then
              DOMAIN="api.pharmacyhub.pk"
              PORT="8080"
              CONTAINER="pharmacyhub-backend-prod"
              CONFIG_ID="10"
            elif [ "$ENV" == "qa" ]; then
              DOMAIN="api.qa.pharmacyhub.pk"
              PORT="8080"
              CONTAINER="pharmacyhub-backend-qa"
              CONFIG_ID="4"
            else
              DOMAIN="api.dev.pharmacyhub.pk"
              PORT="8081"
              CONTAINER="pharmacyhub-backend-dev"
              CONFIG_ID="3"
            fi
            
            # Create backend proxy config
            cat > "/opt/PharmacyHub/infrastructure/proxy/data/nginx/proxy_host/${CONFIG_ID}.conf" << EOFINNER
          # ------------------------------------------------------------
          # ${DOMAIN}
          # ------------------------------------------------------------
          
          map \$scheme \$hsts_header {
              https   "max-age=63072000; preload";
          }
          
          server {
            set \$forward_scheme http;
            set \$server         "${CONTAINER}";
            set \$port           ${PORT};
          
            listen 80;
            listen [::]:80;
          
            server_name ${DOMAIN};
          
            access_log /data/logs/proxy-host-${CONFIG_ID}_access.log proxy;
            error_log /data/logs/proxy-host-${CONFIG_ID}_error.log warn;
          
            location / {
              # Proxy!
              include conf.d/include/proxy.conf;
            }
          
            # Custom
            include /data/nginx/custom/server_proxy[.]conf;
          }
          EOFINNER
          
            echo "Created backend proxy config for ${DOMAIN}"
          done
          
          # Need to restart Nginx Proxy Manager to apply changes
          echo "Restarting Nginx Proxy Manager to apply configurations..."
          docker restart nginx-proxy-manager || true
          
          echo "Proxy configurations setup complete!"
          EOF
          
          # Copy the script to the server
          scp -i ~/.ssh/id_rsa -P ${{ env.VPS_PORT }} setup-proxy-configs.sh ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/PharmacyHub/infrastructure/proxy/setup-proxy-configs.sh
          
          # Make scripts executable and start services
          ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cd /opt/PharmacyHub/infrastructure/proxy && chmod +x *.sh && ./setup-proxy-configs.sh && docker-compose up -d"
          
          echo "Nginx Proxy Manager and Portainer deployed successfully!"

      - name: Verify infrastructure
        run: |
          echo "Verifying infrastructure deployment..."
          ssh -i ~/.ssh/id_rsa -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            echo 'Checking Docker networks...'
            docker network ls | grep -E 'proxy-network|pharmacyhub'
            
            echo 'Checking directory structure...'
            find /opt/PharmacyHub -type d -maxdepth 3 | sort
            
            echo 'Checking Nginx and Portainer containers...'
            docker ps | grep -E 'nginx-proxy-manager|portainer'
          "
          
          echo "Infrastructure verification completed!"
          echo "Nginx Proxy Manager is accessible at: http://${{ env.VPS_HOST }}:81 or https://nginx.pharmacyhub.pk"
          echo "Portainer is accessible at: http://${{ env.VPS_HOST }}:9000 or https://portainer.pharmacyhub.pk"
